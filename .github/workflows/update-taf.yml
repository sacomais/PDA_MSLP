name: Update Data (NOTAMs Hourly / TAF Daily)

on:
  schedule:
    - cron: '0 * * * *' # Cada hora
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup folders
        run: mkdir -p public/data

      # ------------------------------------------------------------------
      # 1. NOTAMS: HYBRID SCRAPER (EXCEL + TABLE FALLBACK)
      # Estrategia: Intentar descargar Excel. Si falla, leer la tabla visualmente.
      # ------------------------------------------------------------------
      - name: Descargar NOTAMs (Hybrid Fail-Safe)
        run: |
          pip install selenium webdriver-manager pandas openpyxl

          cat <<EOF > scrape_notams.py
          import os
          import time
          import json
          import glob
          import pandas as pd
          import re
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC
          from selenium.webdriver.common.keys import Keys

          # Configurar directorios
          download_dir = os.path.abspath("public/data")
          
          # Configurar Chrome
          options = Options()
          options.add_argument("--headless")
          options.add_argument("--window-size=1920,1080")
          options.add_argument("--no-sandbox")
          options.add_argument("--disable-dev-shm-usage")
          options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")
          
          prefs = {
              "download.default_directory": download_dir,
              "download.prompt_for_download": False,
              "directory_upgrade": True
          }
          options.add_experimental_option("prefs", prefs)

          driver = webdriver.Chrome(options=options)
          notams_list = []

          try:
              print("1. Accediendo a FAA Search...")
              driver.get("https://notams.aim.faa.gov/notamSearch/")
              wait = WebDriverWait(driver, 20)

              # --- PASO A: DISCLAIMER ---
              print("2. Aceptando Disclaimer...")
              try:
                  xpath_agree = "//*[contains(text(), \"read and understood\")]"
                  agree_btn = wait.until(EC.element_to_be_clickable((By.XPATH, xpath_agree)))
                  driver.execute_script("arguments[0].click();", agree_btn)
                  print("   ‚úÖ Disclaimer aceptado.")
                  time.sleep(5) # Esperar a que cargue la UI principal
              except:
                  print("   ‚ö†Ô∏è Disclaimer no encontrado (quiz√°s ya aceptado).")

              # --- PASO B: B√öSQUEDA ---
              print("3. Realizando b√∫squeda...")
              
              # Usamos el atributo 'name' que es m√°s seguro que el ID din√°mico
              try:
                  search_input = wait.until(EC.element_to_be_clickable((By.NAME, "designators")))
                  search_input.clear()
                  search_input.send_keys("MSLP")
                  print("   ‚úÖ Texto 'MSLP' ingresado.")
                  time.sleep(1)
                  
                  # Clic expl√≠cito en el bot√≥n SEARCH (mejor que Enter)
                  search_btn = driver.find_element(By.XPATH, "//button[contains(text(), 'Search')]")
                  driver.execute_script("arguments[0].click();", search_btn)
                  print("   ‚úÖ Bot√≥n Search presionado.")
                  
              except Exception as e:
                  print(f"‚ùå Fall√≥ la interacci√≥n de b√∫squeda: {e}")
                  raise e

              print("   ‚è≥ Esperando resultados (15s)...")
              time.sleep(15) # Dar tiempo a que la tabla cargue

              # --- PASO C: INTENTO 1 - EXCEL ---
              print("4. Estrategia A: Intentar descargar Excel...")
              excel_success = False
              try:
                  # Buscamos iconos de Excel o textos de exportar
                  export_btn = driver.find_element(By.CSS_SELECTOR, ".fa-file-excel-o")
                  driver.execute_script("arguments[0].click();", export_btn)
                  print("   ‚úÖ Bot√≥n Excel encontrado y clickeado.")
                  
                  # Esperar descarga
                  time.sleep(10)
                  
                  # Procesar archivo
                  files = glob.glob(os.path.join(download_dir, "*.xlsx")) + glob.glob(os.path.join(download_dir, "*.csv"))
                  if files:
                      latest_file = max(files, key=os.path.getctime)
                      print(f"   üìÇ Archivo descargado: {latest_file}")
                      
                      if latest_file.endswith(".csv"):
                          df = pd.read_csv(latest_file)
                      else:
                          df = pd.read_excel(latest_file)
                      
                      # Convertir filas a NOTAMs
                      for idx, row in df.iterrows():
                          row_str = str(row.values)
                          match = re.search(r'([A-Z]\d{4}/\d{2})', row_str)
                          if match:
                              nid = match.group(1)
                              # Limpiar texto (tomamos el string m√°s largo de la fila como el mensaje)
                              msg = max([str(x) for x in row.values if isinstance(x, str) or not pd.isna(x)], key=len, default="")
                              notams_list.append({
                                  "notamNumber": nid,
                                  "icaoMessage": f"{nid} {msg}",
                                  "startDate": "2025-01-01T00:00:00Z"
                              })
                      excel_success = True
                  else:
                      print("   ‚ö†Ô∏è No se gener√≥ archivo en disco.")
              except Exception as e:
                  print(f"   ‚ö†Ô∏è Fall√≥ descarga Excel: {e}")

              # --- PASO D: INTENTO 2 - LECTURA VISUAL (FALLBACK) ---
              if not excel_success:
                  print("5. Estrategia B: Lectura directa de tabla en pantalla (Fallback)...")
                  
                  # Buscar todas las filas de la tabla de resultados
                  # El ID suele ser searchResultTable o grid
                  rows = driver.find_elements(By.CSS_SELECTOR, "tr")
                  print(f"   Filas encontradas en pantalla: {len(rows)}")
                  
                  for row in rows:
                      text = row.text
                      # Buscar patr√≥n de NOTAM (Axxxx/xx)
                      match = re.search(r'([A-Z]\d{4}/\d{2})', text)
                      if match:
                          nid = match.group(1)
                          clean_msg = text.replace('\n', ' ').strip()
                          
                          # Evitar duplicados si ya existen
                          if not any(n['notamNumber'] == nid for n in notams_list):
                              notams_list.append({
                                  "notamNumber": nid,
                                  "icaoMessage": clean_msg,
                                  "startDate": "2025-01-01T00:00:00Z"
                              })

              # --- RESULTADO FINAL ---
              print(f"‚úÖ FINAL: Se obtuvieron {len(notams_list)} NOTAMs.")
              
              output = { "notamList": notams_list }
              with open('public/data/notams.json', 'w') as f:
                  json.dump(output, f, indent=2)

          except Exception as e:
              print(f"‚ùå Error Cr√≠tico: {e}")
              # Snapshot para debug
              try:
                  print("--- HTML PARCIAL ---")
                  print(driver.page_source[:1000])
              except: pass
              
              with open('public/data/notams.json', 'w') as f:
                  json.dump({"notamList": []}, f)
              exit(1)
          finally:
              driver.quit()
          EOF

          python scrape_notams.py
          
          echo "Vista previa:"
          head -n 20 public/data/notams.json

      # ------------------------------------------------------------------
      # 2. TAF y EXCEL: SOLO A LAS 05:00 UTC (O MANUAL)
      # ------------------------------------------------------------------
      - name: Descargar TAF y Excel (Condicional)
        run: |
          CURRENT_HOUR=$(date -u +%H)
          
          if [ "$CURRENT_HOUR" == "05" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Actualizando TAF y Excel..."
            
            # TAF
            curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/MSLP.TXT" -o tmp_taf.txt
            taf_block=$(awk '/^TAF MSLP/{flag=1} flag{print} /^$/{if(flag){exit}}' tmp_taf.txt)
            if echo "$taf_block" | head -1 | grep -qE "03[0-5][0-9]Z"; then
              echo "$taf_block" > public/data/taf-today.txt
            else
              echo "NIL" > public/data/taf-today.txt
            fi

            # EXCEL
            file_id="1VCS87YR2-O4tJLaJJMVAZtBTPYEQG9fQ"
            curl -L "https://drive.google.com/uc?export=download&id=${file_id}" -o public/operaciones.xlsx
          else
            echo "Se salta la actualizaci√≥n de TAF/Excel (Solo 05 UTC)."
          fi

      # ------------------------------------------------------------------
      # 3. GUARDAR CAMBIOS
      # ------------------------------------------------------------------
      - name: Configurar Git y Guardar
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/taf-today.txt public/operaciones.xlsx public/data/notams.json || true
          
          if git diff --cached --quiet; then
            echo "No hay cambios."
          else
            git commit -m "Auto-update data $(date -u '+%H:%M UTC')"
            git push origin main
          fi
