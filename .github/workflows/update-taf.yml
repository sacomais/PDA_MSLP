name: Update Data (NOTAMs Hourly / TAF Daily)

on:
  schedule:
    # Se ejecuta CADA HORA en el minuto 0 (00:00, 01:00, etc.)
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup folders
        run: mkdir -p public/data

      # ------------------------------------------------------------------
      # 1. NOTAMS: FAA OFICIAL (SE EJECUTA CADA HORA)
      # Solución Híbrida: Obtiene Cookies de sesión primero, luego pide JSON.
      # ------------------------------------------------------------------
      - name: Descargar NOTAMs (FAA Official)
        run: |
          echo "1. Inicializando sesión (obteniendo JSESSIONID)..."
          
          # Paso A: Obtener cookies de la home.
          # -L: Seguir redirecciones
          # -c/-b: Guardar y usar cookies.txt
          curl -s -L -c cookies.txt -b cookies.txt \
               -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36" \
               "https://notams.aim.faa.gov/notamSearch/" > /dev/null

          # Pequeña pausa de seguridad
          sleep 2

          echo "2. Consultando API con Cookies y JSON..."
          
          # Paso B: Petición POST con TODOS los headers de seguridad necesarios.
          # Referer y Origin son obligatorios para evitar el error 302.
          
          curl -v -L -c cookies.txt -b cookies.txt \
               -X POST "https://notams.aim.faa.gov/notamSearch/search" \
               -H "Content-Type: application/json" \
               -H "Accept: application/json, text/plain, */*" \
               -H "X-Requested-With: XMLHttpRequest" \
               -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36" \
               -H "Referer: https://notams.aim.faa.gov/notamSearch/" \
               -H "Origin: https://notams.aim.faa.gov" \
               --data-raw '{"searchType":0,"designators":["MSLP"],"notamsOnly":false,"radius":"10"}' \
               -o public/data/notams_faa.json

          echo "3. Procesando resultados..."

          if [ -s public/data/notams_faa.json ]; then
             echo "✅ Respuesta recibida. Tamaño: $(ls -lh public/data/notams_faa.json | awk '{print $5}')"
             mv public/data/notams_faa.json public/data/notams.json
             echo "Muestra de datos (primeros caracteres):"
             head -c 300 public/data/notams.json
          else
             echo "❌ Error: El servidor no devolvió datos."
             # Generar JSON vacío para no romper la web si falla
             echo '{ "notamList": [] }' > public/data/notams.json
             # No hacemos exit 1 para permitir que el TAF se actualice si es la hora.
          fi

      # ------------------------------------------------------------------
      # 2. TAF y EXCEL: SOLO A LAS 05:00 UTC (O MANUAL)
      # ------------------------------------------------------------------
      - name: Descargar TAF y Excel (Condicional)
        run: |
          CURRENT_HOUR=$(date -u +%H)
          
          # Si es la hora 05 o si se ejecutó manualmente con el botón
          if [ "$CURRENT_HOUR" == "05" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            
            echo "Es la hora programada (05 UTC) o ejecución manual. Actualizando TAF y Excel..."
            
            # --- TAF ---
            curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/MSLP.TXT" -o tmp_taf.txt
            taf_block=$(awk '/^TAF MSLP/{flag=1} flag{print} /^$/{if(flag){exit}}' tmp_taf.txt)
            
            if echo "$taf_block" | head -1 | grep -qE "03[0-5][0-9]Z"; then
              echo "$taf_block" > public/data/taf-today.txt
              echo "✅ TAF de 03Z capturado."
            else
              echo "NIL" > public/data/taf-today.txt
              echo "⚠️ No se encontró TAF 03Z, se puso NIL."
            fi

            # --- EXCEL ---
            file_id="1VCS87YR2-O4tJLaJJMVAZtBTPYEQG9fQ"
            curl -L "https://drive.google.com/uc?export=download&id=${file_id}" -o public/operaciones.xlsx
            echo "✅ Excel descargado."

          else
            echo "⏳ Son las $CURRENT_HOUR UTC. Se salta la actualización de TAF/Excel (Solo a las 05 UTC)."
          fi

      # ------------------------------------------------------------------
      # 3. GUARDAR CAMBIOS EN EL REPO
      # ------------------------------------------------------------------
      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit y Push cambios
        run: |
          # Agregamos los 3 archivos posibles (si no cambiaron, git los ignora)
          git add public/data/taf-today.txt public/operaciones.xlsx public/data/notams.json || true
          
          if git diff --cached --quiet; then
            echo "No hay cambios nuevos para guardar."
          else
            git commit -m "Auto-update data $(date -u '+%H:%M UTC')"
            git push origin main
          fi
