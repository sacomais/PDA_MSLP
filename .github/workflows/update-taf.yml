name: Update Data (NOTAMs Hourly / TAF Daily)

on:
  schedule:
    - cron: '0 * * * *' # Cada hora
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup folders
        run: mkdir -p public/data

      # ------------------------------------------------------------------
      # 1. NOTAMS: SELENIUM EN PILOTWEB (CORREGIDO)
      # Estrategia: Entrar a PilotWeb, buscar botón "Agree", usar URL directa.
      # ------------------------------------------------------------------
      - name: Descargar NOTAMs (PilotWeb Corrected)
        run: |
          pip install selenium webdriver-manager

          cat <<EOF > scrape_notams.py
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC
          import json
          import re
          import time
          import sys

          # Configurar Chrome Headless (Pantalla Grande)
          options = Options()
          options.add_argument("--headless")
          options.add_argument("--window-size=1920,1080")
          options.add_argument("--no-sandbox")
          options.add_argument("--disable-dev-shm-usage")
          options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")

          driver = webdriver.Chrome(options=options)

          try:
              # PASO 1: Ir a la portada PilotWeb
              print("1. Accediendo a portada PilotWeb...")
              driver.get("https://pilotweb.nas.faa.gov/PilotWeb/")
              
              # PASO 2: Buscar el botón correcto ("Agree")
              print("2. Buscando botón 'Agree'...")
              wait = WebDriverWait(driver, 15)
              
              # XPath Robusto: Busca cualquier enlace (a) o input que contenga la palabra "Agree"
              # Esto cubre "I Agree", "Agree", etc.
              try:
                  agree_btn = wait.until(EC.element_to_be_clickable((By.XPATH, "//*[contains(text(), 'Agree')] | //input[@value='I Agree']")))
                  
                  # Clic forzado con JS para asegurar
                  driver.execute_script("arguments[0].click();", agree_btn)
                  print("   ✅ Botón 'Agree' presionado.")
                  time.sleep(2) # Esperar cookie
                  
              except Exception as e:
                  print(f"   ⚠️ No se encontró botón Agree. Verificando si ya estamos dentro...")
                  # A veces si la IP ya visitó, no pide disclaimer. Continuamos.

              # PASO 3: Ir a los resultados de MSLP (URL Directa)
              target_url = "https://pilotweb.nas.faa.gov/PilotWeb/notamRetrievalByICAOAction.do?method=displayByICAOs&reportType=REPORT&actionType=notamRetrievalByICAOs&retrieveLocId=MSLP&formatType=ICAO"
              
              print(f"3. Navegando a resultados MSLP...")
              driver.get(target_url)
              time.sleep(5) # Esperar renderizado

              # PASO 4: Extraer Texto Visual
              body_text = driver.find_element(By.TAG_NAME, "body").text
              print("4. Texto extraído. Analizando...")
              
              # Verificar si seguimos atrapados en el disclaimer
              if "Welcome to NOTAM Search" in body_text and "Agree" in body_text:
                   raise Exception("El disclaimer no se pudo saltar.")

              # Regex para cortar NOTAMs (Axxxx/xx)
              chunks = re.split(r'(?=[A-Z]\d{4}/\d{2})', body_text)
              notams_list = []
              
              for chunk in chunks:
                  chunk = chunk.strip()
                  # Verificar formato ID (Letra + 4 nums + / + 2 nums)
                  match = re.match(r'^([A-Z]\d{4}/\d{2})', chunk)
                  
                  if match:
                      nid = match.group(1)
                      # Limpiar saltos de línea para que quede en una sola línea
                      clean_msg = chunk.replace('\n', ' ').strip()
                      
                      # Filtros de calidad
                      if len(clean_msg) > 15 and "Account" not in nid and "End of Report" not in nid:
                          notams_list.append({
                              "notamNumber": nid,
                              "icaoMessage": clean_msg,
                              "startDate": "2025-01-01T00:00:00Z" 
                          })

              print(f"✅ ÉXITO: Se encontraron {len(notams_list)} NOTAMs.")

              output = { "notamList": notams_list }
              with open('public/data/notams.json', 'w') as f:
                  json.dump(output, f, indent=2)

          except Exception as e:
              print(f"❌ Error Crítico: {e}")
              # Snapshot HTML para debug si falla
              try:
                print("--- DEBUG HTML ---")
                print(driver.page_source[:500])
              except: pass
              
              with open('public/data/notams.json', 'w') as f:
                  json.dump({"notamList": []}, f)
              sys.exit(1)
          finally:
              driver.quit()
          EOF

          python scrape_notams.py
          
          echo "Vista previa JSON:"
          head -n 20 public/data/notams.json

      # ------------------------------------------------------------------
      # 2. TAF y EXCEL: SOLO A LAS 05:00 UTC (O MANUAL)
      # ------------------------------------------------------------------
      - name: Descargar TAF y Excel (Condicional)
        run: |
          CURRENT_HOUR=$(date -u +%H)
          
          if [ "$CURRENT_HOUR" == "05" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Actualizando TAF y Excel..."
            
            # TAF
            curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/MSLP.TXT" -o tmp_taf.txt
            taf_block=$(awk '/^TAF MSLP/{flag=1} flag{print} /^$/{if(flag){exit}}' tmp_taf.txt)
            if echo "$taf_block" | head -1 | grep -qE "03[0-5][0-9]Z"; then
              echo "$taf_block" > public/data/taf-today.txt
            else
              echo "NIL" > public/data/taf-today.txt
            fi

            # EXCEL
            file_id="1VCS87YR2-O4tJLaJJMVAZtBTPYEQG9fQ"
            curl -L "https://drive.google.com/uc?export=download&id=${file_id}" -o public/operaciones.xlsx
          else
            echo "Se salta la actualización de TAF/Excel (Solo 05 UTC)."
          fi

      # ------------------------------------------------------------------
      # 3. GUARDAR CAMBIOS
      # ------------------------------------------------------------------
      - name: Configurar Git y Guardar
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/taf-today.txt public/operaciones.xlsx public/data/notams.json || true
          
          if git diff --cached --quiet; then
            echo "No hay cambios."
          else
            git commit -m "Auto-update data $(date -u '+%H:%M UTC')"
            git push origin main
          fi
