name: Update Data (NOTAMs Hourly / TAF Daily)

on:
  schedule:
    # Se ejecuta CADA HORA en el minuto 0 (00:00, 01:00, 02:00...)
    # Si quieres cada 30 mins, usa: '*/30 * * * *'
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup folders
        run: mkdir -p public/data

      # ------------------------------------------------------------------
      # 1. NOTAMS: Fuente Oficial FAA (Sin API Key)
      # ------------------------------------------------------------------
      - name: Descargar NOTAMs (FAA Official)
        run: |
          echo "Consultando API de la FAA..."
          
          # La FAA usa un endpoint POST que devuelve JSON.
          # Enviamos los parámetros para buscar por ICAO: MSLP
          
          curl -s -X POST "https://notams.aim.faa.gov/notamSearch/search" \
               -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" \
               -d "searchType=0&designatorsForMessage=false&designators=MSLP&notamsOnly=false&radius=10" \
               -o public/data/notams_faa.json

          echo "Respuesta recibida. Filtrando datos..."
          
          # La FAA devuelve mucha "basura" técnica. Vamos a limpiar y guardar solo la lista.
          # Usamos 'jq' (JSON Processor) que ya viene instalado en GitHub Actions, 
          # o simplemente guardamos el archivo tal cual y lo procesamos en JS.
          # Para simplificar, guardamos el raw y dejamos que el JS haga el trabajo sucio.
          
          mv public/data/notams_faa.json public/data/notams.json
          
          echo "Vista previa:"
          head -c 200 public/data/notams.json

      # ------------------------------------------------------------------
      # 2. TAF y EXCEL: Solo a las 05:00 UTC (o si es manual)
      # ------------------------------------------------------------------
      - name: Descargar TAF y Excel (Solo a las 05 UTC)
        run: |
          # Obtenemos la hora actual UTC
          CURRENT_HOUR=$(date -u +%H)
          
          # Condición: Si es la hora 05 O si la ejecución fue manual (botón)
          if [ "$CURRENT_HOUR" == "05" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            
            echo "Es la hora programada (05 UTC) o ejecución manual. Actualizando TAF y Excel..."
            
            # --- BLOQUE TAF ORIGINAL ---
            curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/MSLP.TXT" -o tmp_taf.txt
            taf_block=$(awk '/^TAF MSLP/{flag=1} flag{print} /^$/{if(flag){exit}}' tmp_taf.txt)
            
            # Tu validación de 03Z
            if echo "$taf_block" | head -1 | grep -qE "03[0-5][0-9]Z"; then
              echo "$taf_block" > public/data/taf-today.txt
              echo "✅ TAF de 03Z capturado correctamente"
            else
              # Opcional: Si prefieres no sobrescribir si falla, comenta la linea de abajo
              echo "NIL" > public/data/taf-today.txt
              echo "⚠️ No se encontró TAF 03Z, se puso NIL."
            fi

            # --- BLOQUE EXCEL ORIGINAL ---
            file_id="1VCS87YR2-O4tJLaJJMVAZtBTPYEQG9fQ"
            curl -L "https://drive.google.com/uc?export=download&id=${file_id}" -o public/operaciones.xlsx
            echo "✅ Excel descargado."

          else
            echo "⏳ Son las $CURRENT_HOUR UTC. Se salta la actualización de TAF/Excel (Programada para 05 UTC)."
          fi

      # ------------------------------------------------------------------
      # 3. COMMIT: Guarda lo que haya cambiado
      # ------------------------------------------------------------------
      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit y Push cambios
        run: |
          # Intentamos agregar todo. Git es inteligente: 
          # si el TAF/Excel no se tocaron (porque no era la hora), no se commitean.
          # Solo se commiteará el notams.json si cambió.
          
          git add public/data/taf-today.txt public/operaciones.xlsx public/data/notams.json || true
          
          if git diff --cached --quiet; then
            echo "No hay cambios nuevos para guardar."
          else
            git commit -m "Auto-update data $(date -u '+%H:%M UTC')"
            git push origin main
          fi
