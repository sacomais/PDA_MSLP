name: Update Data (NOTAMs Hourly / TAF Daily)

on:
  schedule:
    - cron: '0 * * * *' # Ejecutar cada hora
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup folders
        run: mkdir -p public/data

      # ------------------------------------------------------------------
      # 1. NOTAMS: FAA SCRAPER CON PYTHON (Manejo de Sesión Real)
      # ------------------------------------------------------------------
      - name: Descargar NOTAMs (Python Session)
        run: |
          # Creamos el script de Python al vuelo
          cat <<EOF > scrape_notams.py
          import requests
          import json
          import sys
          import time

          # Configuración para parecer un navegador real
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Referer': 'https://notams.aim.faa.gov/notamSearch/',
              'Origin': 'https://notams.aim.faa.gov',
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
          }

          try:
              print("1. Iniciando sesión de navegador...")
              s = requests.Session()
              s.headers.update(headers)

              # PASO A: Visitar la home para obtener cookies de sesión
              r_init = s.get('https://notams.aim.faa.gov/notamSearch/', timeout=15)
              print(f"   Status Home: {r_init.status_code}")
              time.sleep(2) # Pausa humana

              # PASO B: Realizar la búsqueda
              print("2. Buscando NOTAMs para MSLP...")
              
              # Payload exacto que envía el navegador (Form Data)
              payload = {
                  'searchType': '0',
                  'designatorsForMessage': 'false',
                  'designators': 'MSLP',
                  'notamsOnly': 'false',
                  'radius': '10',
                  'sortColumns': 'false'
              }
              
              r_search = s.post('https://notams.aim.faa.gov/notamSearch/search', data=payload, timeout=15)
              print(f"   Status Búsqueda: {r_search.status_code}")

              if r_search.status_code != 200:
                  print(f"Error: El servidor respondió {r_search.status_code}")
                  sys.exit(1)

              # PASO C: Procesar Respuesta
              data = r_search.json()
              
              # La FAA devuelve { "notamList": [ ... ], ... }
              if 'notamList' in data:
                  count = len(data['notamList'])
                  print(f"✅ ÉXITO: Se encontraron {count} NOTAMs.")
                  
                  # Guardar JSON
                  with open('public/data/notams.json', 'w') as f:
                      json.dump(data, f, indent=2)
              else:
                  print("⚠️ Advertencia: Estructura JSON inesperada o vacía.")
                  print(str(data)[:200]) # Imprimir el inicio para debug
                  # Crear vacío para no romper
                  with open('public/data/notams.json', 'w') as f:
                      json.dump({"notamList": []}, f)

          except Exception as e:
              print(f"❌ Error crítico en el script: {e}")
              # Generar archivo vacío de seguridad
              with open('public/data/notams.json', 'w') as f:
                  json.dump({"notamList": []}, f)
              sys.exit(1)
          EOF

          # Ejecutar el script que acabamos de crear
          python scrape_notams.py
          
          echo "Vista previa del archivo generado:"
          head -n 20 public/data/notams.json

      # ------------------------------------------------------------------
      # 2. TAF y EXCEL: SOLO A LAS 05:00 UTC (O MANUAL)
      # ------------------------------------------------------------------
      - name: Descargar TAF y Excel (Condicional)
        run: |
          CURRENT_HOUR=$(date -u +%H)
          
          if [ "$CURRENT_HOUR" == "05" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Actualizando TAF y Excel..."
            
            # TAF
            curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/MSLP.TXT" -o tmp_taf.txt
            taf_block=$(awk '/^TAF MSLP/{flag=1} flag{print} /^$/{if(flag){exit}}' tmp_taf.txt)
            if echo "$taf_block" | head -1 | grep -qE "03[0-5][0-9]Z"; then
              echo "$taf_block" > public/data/taf-today.txt
            else
              echo "NIL" > public/data/taf-today.txt
            fi

            # EXCEL
            file_id="1VCS87YR2-O4tJLaJJMVAZtBTPYEQG9fQ"
            curl -L "https://drive.google.com/uc?export=download&id=${file_id}" -o public/operaciones.xlsx
          else
            echo "Se salta la actualización de TAF/Excel (Solo 05 UTC)."
          fi

      # ------------------------------------------------------------------
      # 3. GUARDAR CAMBIOS
      # ------------------------------------------------------------------
      - name: Configurar Git y Guardar
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/taf-today.txt public/operaciones.xlsx public/data/notams.json || true
          
          if git diff --cached --quiet; then
            echo "No hay cambios."
          else
            git commit -m "Auto-update data $(date -u '+%H:%M UTC')"
            git push origin main
          fi
