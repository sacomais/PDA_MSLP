name: Update Data (NOTAMs Hourly / TAF Daily)

on:
  schedule:
    # Se ejecuta CADA HORA en el minuto 0 (00:00, 01:00, 02:00...)
    # Si quieres cada 30 mins, usa: '*/30 * * * *'
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup folders
        run: mkdir -p public/data

      # ------------------------------------------------------------------
      # NOTAMS: PLAN B (Web Scraping Robusto con Node.js)
      # ------------------------------------------------------------------
      - name: Descargar y Procesar NOTAMs
        run: |
          echo "1. Descargando HTML de fuente pública..."
          # Descargamos la web de Fallston Group que muestra los NOTAMs de MSLP limpios
          curl -s "https://www.fallston-group.com/notam-result.php?icao=MSLP" -o raw_notams.html

          echo "2. Convirtiendo HTML a JSON..."
          
          # Usamos un pequeño script de Node.js (ya instalado en GitHub Actions)
          # para extraer el texto dentro de las etiquetas <pre> y crear el JSON.
          
          node -e '
            const fs = require("fs");
            try {
              // Leer el HTML descargado
              const html = fs.readFileSync("raw_notams.html", "utf8");
              
              // Buscar todo lo que esté entre etiquetas <pre>...</pre>
              const regex = /<pre>([\s\S]*?)<\/pre>/g;
              let match;
              const notams = [];
              
              while ((match = regex.exec(html)) !== null) {
                // Limpiar espacios extra y saltos de línea raros
                let text = match[1].trim();
                if (text.length > 5) { // Ignorar vacíos
                   // Creamos el objeto con la clave "icaoMessage" que espera tu JS
                   notams.push({ 
                     icaoMessage: text,
                     startDate: new Date().toISOString() // Fecha dummy para que aparezca arriba
                   });
                }
              }
              
              // Guardar el JSON final
              const output = { notamList: notams };
              fs.writeFileSync("public/data/notams.json", JSON.stringify(output, null, 2));
              console.log("JSON generado con " + notams.length + " NOTAMs.");
              
            } catch (e) {
              console.error("Error procesando:", e);
              process.exit(1);
            }
          '

          echo "Vista previa del JSON:"
          head -n 15 public/data/notams.json

      # ------------------------------------------------------------------
      # 2. TAF y EXCEL: Solo a las 05:00 UTC (o si es manual)
      # ------------------------------------------------------------------
      - name: Descargar TAF y Excel (Solo a las 05 UTC)
        run: |
          # Obtenemos la hora actual UTC
          CURRENT_HOUR=$(date -u +%H)
          
          # Condición: Si es la hora 05 O si la ejecución fue manual (botón)
          if [ "$CURRENT_HOUR" == "05" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            
            echo "Es la hora programada (05 UTC) o ejecución manual. Actualizando TAF y Excel..."
            
            # --- BLOQUE TAF ORIGINAL ---
            curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/MSLP.TXT" -o tmp_taf.txt
            taf_block=$(awk '/^TAF MSLP/{flag=1} flag{print} /^$/{if(flag){exit}}' tmp_taf.txt)
            
            # Tu validación de 03Z
            if echo "$taf_block" | head -1 | grep -qE "03[0-5][0-9]Z"; then
              echo "$taf_block" > public/data/taf-today.txt
              echo "✅ TAF de 03Z capturado correctamente"
            else
              # Opcional: Si prefieres no sobrescribir si falla, comenta la linea de abajo
              echo "NIL" > public/data/taf-today.txt
              echo "⚠️ No se encontró TAF 03Z, se puso NIL."
            fi

            # --- BLOQUE EXCEL ORIGINAL ---
            file_id="1VCS87YR2-O4tJLaJJMVAZtBTPYEQG9fQ"
            curl -L "https://drive.google.com/uc?export=download&id=${file_id}" -o public/operaciones.xlsx
            echo "✅ Excel descargado."

          else
            echo "⏳ Son las $CURRENT_HOUR UTC. Se salta la actualización de TAF/Excel (Programada para 05 UTC)."
          fi

      # ------------------------------------------------------------------
      # 3. COMMIT: Guarda lo que haya cambiado
      # ------------------------------------------------------------------
      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit y Push cambios
        run: |
          # Intentamos agregar todo. Git es inteligente: 
          # si el TAF/Excel no se tocaron (porque no era la hora), no se commitean.
          # Solo se commiteará el notams.json si cambió.
          
          git add public/data/taf-today.txt public/operaciones.xlsx public/data/notams.json || true
          
          if git diff --cached --quiet; then
            echo "No hay cambios nuevos para guardar."
          else
            git commit -m "Auto-update data $(date -u '+%H:%M UTC')"
            git push origin main
          fi
