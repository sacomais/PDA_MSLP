name: Update Data (NOTAMs Hourly / TAF Daily)

on:
  schedule:
    - cron: '0 * * * *' # Ejecutar cada hora
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup folders
        run: mkdir -p public/data

      # ------------------------------------------------------------------
      # 1. NOTAMS: AVIATION WEATHER CENTER (NOAA) - JSON NATIVO
      # Fuente oficial, sin bloqueos, sin scraping.
      # ------------------------------------------------------------------
      - name: Descargar NOTAMs (AWC API)
        run: |
          echo "Consultando AviationWeather.gov..."
          
          # URL oficial de la API Beta de NOAA/AWC
          # ids=MSLP : Aeropuerto
          # format=json : Formato que necesitamos
          
          curl -s -L -A "Mozilla/5.0" \
            "https://aviationweather.gov/api/data/notam?ids=MSLP&format=json" \
            -o public/data/notams_raw.json

          echo "Procesando respuesta..."

          # Usamos Node para adaptar el JSON al formato que espera tu app (notamList)
          node -e '
            const fs = require("fs");
            try {
              // Leer el archivo descargado
              const raw = fs.readFileSync("public/data/notams_raw.json", "utf8");
              
              // AWC devuelve un array directo: [ { "id": "...", "text": "..." }, ... ]
              let data = JSON.parse(raw);
              
              // Si no es un array (error), lo forzamos
              if (!Array.isArray(data)) { data = []; }
              
              console.log("Se recibieron " + data.length + " NOTAMs.");
              
              // Mapeamos los campos para que coincidan con lo que espera tu app.notams.js
              // Tu app espera: { icaoMessage: "TEXTO...", startDate: "..." }
              const mapped = data.map(item => {
                 // AWC pone el texto en "raw" o "text"
                 return {
                   notamNumber: item.id, // Ej: A0324/25
                   icaoMessage: item.raw || item.text || "",
                   startDate: item.time ? item.time.start : new Date().toISOString(),
                   endDate: item.time ? item.time.end : null
                 };
              });
              
              // Guardamos en el formato final
              const output = { notamList: mapped };
              fs.writeFileSync("public/data/notams.json", JSON.stringify(output, null, 2));
              
            } catch (e) {
              console.error("Error procesando JSON:", e);
              // Generar vacío en caso de error
              fs.writeFileSync("public/data/notams.json", JSON.stringify({ notamList: [] }));
            }
          '

          echo "Vista previa:"
          head -n 20 public/data/notams.json

      # ------------------------------------------------------------------
      # 2. TAF y EXCEL: SOLO A LAS 05:00 UTC (O MANUAL)
      # ------------------------------------------------------------------
      - name: Descargar TAF y Excel (Condicional)
        run: |
          CURRENT_HOUR=$(date -u +%H)
          
          if [ "$CURRENT_HOUR" == "05" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Actualizando TAF y Excel..."
            
            # TAF
            curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/MSLP.TXT" -o tmp_taf.txt
            taf_block=$(awk '/^TAF MSLP/{flag=1} flag{print} /^$/{if(flag){exit}}' tmp_taf.txt)
            if echo "$taf_block" | head -1 | grep -qE "03[0-5][0-9]Z"; then
              echo "$taf_block" > public/data/taf-today.txt
            else
              echo "NIL" > public/data/taf-today.txt
            fi

            # EXCEL
            file_id="1VCS87YR2-O4tJLaJJMVAZtBTPYEQG9fQ"
            curl -L "https://drive.google.com/uc?export=download&id=${file_id}" -o public/operaciones.xlsx
          else
            echo "Se salta la actualización de TAF/Excel (Solo 05 UTC)."
          fi

      # ------------------------------------------------------------------
      # 3. GUARDAR CAMBIOS
      # ------------------------------------------------------------------
      - name: Configurar Git y Guardar
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/taf-today.txt public/operaciones.xlsx public/data/notams.json || true
          
          if git diff --cached --quiet; then
            echo "No hay cambios."
          else
            git commit -m "Auto-update data $(date -u '+%H:%M UTC')"
            git push origin main
          fi
