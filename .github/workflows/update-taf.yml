name: Update Data (NOTAMs Hourly / TAF Daily)

on:
  schedule:
    - cron: '0 * * * *' # Cada hora
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup folders
        run: mkdir -p public/data

      # ------------------------------------------------------------------
      # 1. NOTAMS: EXCEL STRATEGY (FIXED SELECTORS)
      # ------------------------------------------------------------------
      - name: Descargar y Procesar Excel FAA
        run: |
          pip install selenium webdriver-manager pandas openpyxl

          cat <<EOF > scrape_notams.py
          import os
          import time
          import json
          import glob
          import pandas as pd
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC
          from selenium.webdriver.common.keys import Keys

          # Directorio de descarga
          download_dir = os.path.abspath("public/data")
          
          # Configurar Chrome
          options = Options()
          options.add_argument("--headless")
          options.add_argument("--window-size=1920,1080")
          options.add_argument("--no-sandbox")
          options.add_argument("--disable-dev-shm-usage")
          options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")
          
          prefs = {
              "download.default_directory": download_dir,
              "download.prompt_for_download": False,
              "directory_upgrade": True
          }
          options.add_experimental_option("prefs", prefs)

          driver = webdriver.Chrome(options=options)

          try:
              print("1. Accediendo a FAA Search...")
              driver.get("https://notams.aim.faa.gov/notamSearch/")
              wait = WebDriverWait(driver, 20)

              # PASO A: Disclaimer
              print("2. Aceptando Disclaimer...")
              try:
                  xpath_agree = "//*[contains(text(), \"read and understood\")]"
                  agree_btn = wait.until(EC.element_to_be_clickable((By.XPATH, xpath_agree)))
                  driver.execute_script("arguments[0].click();", agree_btn)
                  print("   ✅ Disclaimer aceptado.")
              except:
                  print("   ⚠️ No se pidió disclaimer (o falló). Intentando seguir.")

              # PAUSA CRÍTICA: Esperar a que la App Angular cargue la interfaz de búsqueda
              print("   ⏳ Esperando carga de la interfaz (10s)...")
              time.sleep(10)

              # PASO B: Búsqueda
              print("3. Buscando caja de texto (ID: searchDesignators)...")
              
              # Intentamos varios selectores por si acaso
              try:
                  # Selector oficial por ID
                  search_input = wait.until(EC.element_to_be_clickable((By.ID, "searchDesignators")))
              except:
                  # Fallback: buscar cualquier input visible
                  print("   ⚠️ ID no encontrado, probando selector genérico...")
                  search_input = driver.find_element(By.XPATH, "//input[@type='text']")

              search_input.clear()
              search_input.send_keys("MSLP")
              time.sleep(1)
              search_input.send_keys(Keys.ENTER) # Presionar Enter directamente
              print("   ✅ 'MSLP' enviado + Enter.")
              
              # Esperar resultados
              print("   ⏳ Esperando resultados de la tabla (10s)...")
              time.sleep(10)

              # PASO C: Exportar
              print("4. Intentando Exportar a Excel...")
              
              # Buscamos el botón de exportar. 
              # A veces está dentro de un menú 'Export Options' o es un icono.
              try:
                  # Intento 1: Buscar botón que contenga "Export"
                  export_btn = driver.find_element(By.XPATH, "//*[contains(text(), 'Export')]")
                  driver.execute_script("arguments[0].click();", export_btn)
                  
                  # A veces abre un submenú "Excel"
                  time.sleep(1)
                  try:
                      excel_opt = driver.find_element(By.XPATH, "//*[contains(text(), 'Excel')]")
                      driver.execute_script("arguments[0].click();", excel_opt)
                      print("   ✅ Click en Submenú Excel.")
                  except:
                      print("   ✅ Click en Exportar (Directo).")

              except Exception as e:
                  print(f"   ⚠️ Falló selector 'Export' por texto. Probando iconos...")
                  # Intento 2: Iconos de FontAwesome fa-file-excel-o
                  icons = driver.find_elements(By.CSS_SELECTOR, ".fa-file-excel-o")
                  if icons:
                      driver.execute_script("arguments[0].click();", icons[0])
                      print("   ✅ Click en Icono Excel.")
                  else:
                      print("❌ NO SE PUDO EXPORTAR. Imprimiendo HTML para debug:")
                      print(driver.page_source[:500])
                      raise e

              # Esperar descarga
              print("   ⏳ Esperando archivo (15s)...")
              time.sleep(15)

              # PASO D: Procesar
              print("5. Procesando Excel...")
              
              # Patrón de búsqueda flexible
              files = glob.glob(os.path.join(download_dir, "*.*"))
              # Filtrar solo xlsx o csv recientes
              excel_files = [f for f in files if f.endswith(".xlsx") or f.endswith(".csv")]
              
              if not excel_files:
                  print("❌ No se encontró el archivo descargado. Archivos en carpeta:")
                  print(files)
                  raise Exception("Carpeta vacía de excels.")

              latest_file = max(excel_files, key=os.path.getctime)
              print(f"   Archivo capturado: {latest_file}")

              # Leer Excel
              if latest_file.endswith(".csv"):
                  df = pd.read_csv(latest_file)
              else:
                  df = pd.read_excel(latest_file)
              
              # Convertir a JSON
              notams_list = []
              
              # Iteramos filas. La FAA suele poner el ID en una columna y el texto en otra.
              # Concatenamos todo lo útil de la fila.
              for idx, row in df.iterrows():
                  # Convertimos la fila a string para buscar patrones, es más seguro que adivinar nombres de columna
                  row_str = str(row.values)
                  
                  # Buscamos un ID de NOTAM en toda la fila (Axxxx/xx)
                  # Esto evita que falle si cambian el nombre de la columna "Account" a "Number"
                  import re
                  match = re.search(r'([A-Z]\d{4}/\d{2})', str(row_str))
                  
                  if match:
                      nid = match.group(1)
                      # El mensaje suele ser la celda más larga de la fila
                      # Encontramos la celda de texto más larga
                      msg = max([str(x) for x in row.values], key=len)
                      
                      notams_list.append({
                          "notamNumber": nid,
                          "icaoMessage": f"{nid} {msg}",
                          "startDate": "2025-01-01T00:00:00Z"
                      })

              print(f"✅ ÉXITO: {len(notams_list)} NOTAMs extraídos.")
              
              output = { "notamList": notams_list }
              with open('public/data/notams.json', 'w') as f:
                  json.dump(output, f, indent=2)
                  
              # Limpieza
              os.remove(latest_file)

          except Exception as e:
              print(f"❌ Error Crítico: {e}")
              with open('public/data/notams.json', 'w') as f:
                  json.dump({"notamList": []}, f)
              exit(1)
          finally:
              driver.quit()
          EOF

          python scrape_notams.py
          
          echo "Vista previa:"
          head -n 20 public/data/notams.json

      # ------------------------------------------------------------------
      # 2. TAF y EXCEL: SOLO A LAS 05:00 UTC (O MANUAL)
      # ------------------------------------------------------------------
      - name: Descargar TAF y Excel (Condicional)
        run: |
          CURRENT_HOUR=$(date -u +%H)
          
          if [ "$CURRENT_HOUR" == "05" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Actualizando TAF y Excel..."
            
            # TAF
            curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/MSLP.TXT" -o tmp_taf.txt
            taf_block=$(awk '/^TAF MSLP/{flag=1} flag{print} /^$/{if(flag){exit}}' tmp_taf.txt)
            if echo "$taf_block" | head -1 | grep -qE "03[0-5][0-9]Z"; then
              echo "$taf_block" > public/data/taf-today.txt
            else
              echo "NIL" > public/data/taf-today.txt
            fi

            # EXCEL
            file_id="1VCS87YR2-O4tJLaJJMVAZtBTPYEQG9fQ"
            curl -L "https://drive.google.com/uc?export=download&id=${file_id}" -o public/operaciones.xlsx
          else
            echo "Se salta la actualización de TAF/Excel (Solo 05 UTC)."
          fi

      # ------------------------------------------------------------------
      # 3. GUARDAR CAMBIOS
      # ------------------------------------------------------------------
      - name: Configurar Git y Guardar
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/taf-today.txt public/operaciones.xlsx public/data/notams.json || true
          
          if git diff --cached --quiet; then
            echo "No hay cambios."
          else
            git commit -m "Auto-update data $(date -u '+%H:%M UTC')"
            git push origin main
          fi
