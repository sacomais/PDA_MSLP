name: Update Data (NOTAMs Hourly / TAF Daily)

on:
  schedule:
    - cron: '0 * * * *' # Ejecutar cada hora
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup folders
        run: mkdir -p public/data

      # ------------------------------------------------------------------
      # 1. NOTAMS: ESTRATEGIA PILOTWEB (LEGACY)
      # Conectamos directo al sistema antiguo que no tiene bloqueos complejos.
      # ------------------------------------------------------------------
      - name: Descargar NOTAMs (Legacy PilotWeb)
        run: |
          echo "1. Descargando HTML de PilotWeb..."
          
          # URL directa que genera el reporte para MSLP
          # Usamos -L para seguir redirecciones y un User-Agent genérico
          curl -s -L -A "Mozilla/5.0" \
            "https://pilotweb.nas.faa.gov/PilotWeb/notamRetrievalByICAOAction.do?method=displayByICAOs&reportType=REPORT&actionType=notamRetrievalByICAOs&retrieveLocId=MSLP&formatType=ICAO" \
            -o raw_pilotweb.html

          echo "2. Extrayendo NOTAMs y convirtiendo a JSON..."

          # Usamos Node.js para leer el HTML y sacar los textos limpios
          node -e '
            const fs = require("fs");
            try {
              const html = fs.readFileSync("raw_pilotweb.html", "utf8");
              
              // PilotWeb pone el texto del NOTAM dentro de <div class="notamText"> o similar.
              // Pero lo más seguro es buscar el patrón de ID de NOTAM (ej: A1234/25)
              // Regex: Busca una letra mayúscula, 4 dígitos, barra, 2 dígitos (Inicio del NOTAM)
              // y captura hasta el siguiente salto de línea doble o fin de etiqueta.
              
              // Estrategia de limpieza:
              // 1. Eliminar tags HTML
              let cleanText = html.replace(/<[^>]*>/g, "\n");
              // 2. Normalizar espacios
              cleanText = cleanText.replace(/&nbsp;/g, " ").replace(/\r\n/g, "\n");
              
              const notams = [];
              const lines = cleanText.split("\n");
              
              let buffer = "";
              let currentId = "";
              
              // Leemos línea por línea para reconstruir los bloques
              lines.forEach(line => {
                const l = line.trim();
                if (!l) return; // Saltar vacíos
                
                // Detectar inicio de NOTAM (Ej: A1459/25 NOTAMN)
                // Regex: Letra + 4 digitos + / + 2 digitos
                const matchId = l.match(/^([A-Z]\d{4}\/\d{2})\s+/);
                
                if (matchId) {
                   // Si ya teníamos uno en buffer, lo guardamos
                   if (currentId) {
                     notams.push({ notamNumber: currentId, icaoMessage: buffer.trim() });
                   }
                   // Iniciar nuevo
                   currentId = matchId[1];
                   buffer = l;
                } else if (currentId) {
                   // Continuar acumulando líneas al NOTAM actual
                   // Ignoramos textos de sistema como "Account..." o "End of Report"
                   if (!l.includes("Account") && !l.includes("End of Report")) {
                      buffer += " " + l;
                   }
                }
              });
              
              // Guardar el último del buffer
              if (currentId) {
                 notams.push({ notamNumber: currentId, icaoMessage: buffer.trim() });
              }

              // Guardar JSON final compatible con tu app
              const output = { notamList: notams };
              fs.writeFileSync("public/data/notams.json", JSON.stringify(output, null, 2));
              
              console.log("✅ Se extrajeron " + notams.length + " NOTAMs.");
              
            } catch (e) {
              console.error("Error en parsing:", e);
              // Generar array vacío en caso de error para no romper la web
              fs.writeFileSync("public/data/notams.json", JSON.stringify({ notamList: [] }));
            }
          '

          echo "Vista previa:"
          head -n 20 public/data/notams.json

      # ------------------------------------------------------------------
      # 2. TAF y EXCEL: SOLO A LAS 05:00 UTC (O MANUAL)
      # ------------------------------------------------------------------
      - name: Descargar TAF y Excel (Condicional)
        run: |
          CURRENT_HOUR=$(date -u +%H)
          
          if [ "$CURRENT_HOUR" == "05" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Actualizando TAF y Excel..."
            
            # TAF
            curl -s "https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/MSLP.TXT" -o tmp_taf.txt
            taf_block=$(awk '/^TAF MSLP/{flag=1} flag{print} /^$/{if(flag){exit}}' tmp_taf.txt)
            if echo "$taf_block" | head -1 | grep -qE "03[0-5][0-9]Z"; then
              echo "$taf_block" > public/data/taf-today.txt
            else
              echo "NIL" > public/data/taf-today.txt
            fi

            # EXCEL
            file_id="1VCS87YR2-O4tJLaJJMVAZtBTPYEQG9fQ"
            curl -L "https://drive.google.com/uc?export=download&id=${file_id}" -o public/operaciones.xlsx
          else
            echo "Se salta la actualización de TAF/Excel (Solo 05 UTC)."
          fi

      # ------------------------------------------------------------------
      # 3. GUARDAR CAMBIOS
      # ------------------------------------------------------------------
      - name: Configurar Git y Guardar
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/taf-today.txt public/operaciones.xlsx public/data/notams.json || true
          
          if git diff --cached --quiet; then
            echo "No hay cambios."
          else
            git commit -m "Auto-update data $(date -u '+%H:%M UTC')"
            git push origin main
          fi
